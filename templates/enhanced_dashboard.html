<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRI Dashboard - Advanced Behavioral Risk Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1A365D;
            --secondary: #2D3748;
            --accent: #C53030;
            --background: #F7FAFC;
            --card-bg: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #4A5568;
            --border: #E2E8F0;
            --shadow: rgba(26, 32, 44, 0.1);
            --risk-low: #38A169;
            --risk-moderate: #D69E2E;
            --risk-high: #E53E3E;
        }
        
        [data-theme="dark"] {
            --primary: #2B6CB0;
            --secondary: #4A5568;
            --accent: #FC8181;
            --background: #0F1419;
            --card-bg: #1A202C;
            --text-primary: #F7FAFC;
            --text-secondary: #A0AEC0;
            --border: #2D3748;
            --shadow: rgba(0, 0, 0, 0.4);
            --risk-low: #68D391;
            --risk-moderate: #F6E05E;
            --risk-high: #FC8181;
        }
        
        body {
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            box-shadow: 0 2px 10px var(--shadow);
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 1rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-bottom: none;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--card-bg) 0%, #f8f9fa 100%);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .risk-low { color: var(--risk-low); }
        .risk-moderate { color: var(--risk-moderate); }
        .risk-high { color: var(--risk-high); }
        
        /* Enhanced Chart Containers */
        .chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--card-bg);
            position: relative;
            overflow: hidden;
        }
        
        .chart-container-large {
            height: 500px;
        }
        
        .chart-container-small {
            height: 300px;
        }
        
        .chart-container-medium {
            height: 350px;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        /* Enhanced Grid Layout */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .chart-grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .chart-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .chart-grid-single {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Tab Navigation */
        .nav-tabs {
            border-bottom: 2px solid var(--border);
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background-color: transparent;
        }
        
        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        /* Prediction Cards */
        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .prediction-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* EMA Values */
        .ema-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .ema-item {
            text-align: center;
            padding: 0.5rem;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            min-width: 100px;
        }
        
        .ema-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .ema-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Enhanced Information Cards */
        .info-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .info-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .info-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Responsive Design */
        @media (max-width: 576px) {
            .stat-value {
                font-size: 1.5rem;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-container-large {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                BRI Dashboard - Advanced Analytics
            </a>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light me-3" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <span class="text-white-50 small">Live at <a href="https://web-production-ad69da.up.railway.app/" class="text-white" target="_blank">railway.app</a></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Enhanced Summary Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value risk-moderate" id="current-bri">Loading...</div>
                <div class="stat-label">Current BRI</div>
                <div class="stat-label" id="bri-change">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mean-bri">--</div>
                <div class="stat-label">Mean BRI</div>
                <div class="stat-label" id="bri-volatility">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="correlation">--</div>
                <div class="stat-label">BRI-VIX Correlation</div>
                <div class="stat-label" id="correlation-strength">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="trend">--</div>
                <div class="stat-label">30-Day Trend</div>
                <div class="stat-label" id="trend-strength">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="min-bri">--</div>
                <div class="stat-label">Minimum BRI</div>
                <div class="stat-label" id="min-date">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="max-bri">--</div>
                <div class="stat-label">Maximum BRI</div>
                <div class="stat-label" id="max-date">--</div>
            </div>
        </div>

        <!-- EMA Values Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Moving Averages & Technical Indicators
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="ema-container">
                            <div class="ema-item">
                                <div class="ema-value" id="ema-7">--</div>
                                <div class="ema-label">7-Day EMA</div>
                            </div>
                            <div class="ema-item">
                                <div class="ema-value" id="ema-14">--</div>
                                <div class="ema-label">14-Day EMA</div>
                            </div>
                            <div class="ema-item">
                                <div class="ema-value" id="ema-21">--</div>
                                <div class="ema-label">21-Day EMA</div>
                            </div>
                            <div class="ema-item">
                                <div class="ema-value" id="ema-30">--</div>
                                <div class="ema-label">30-Day EMA</div>
                            </div>
                            <div class="ema-item">
                                <div class="ema-value" id="ema-50">--</div>
                                <div class="ema-label">50-Day EMA</div>
                            </div>
                            <div class="ema-item">
                                <div class="ema-value" id="ema-100">--</div>
                                <div class="ema-label">100-Day EMA</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Predictions Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-crystal-ball me-2"></i>
                            BRI Future Predictions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="prediction-card">
                                    <div class="prediction-value" id="pred-1d">--</div>
                                    <div class="stat-label">1-Day Prediction</div>
                                    <div class="stat-label" id="pred-1d-confidence">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="prediction-card">
                                    <div class="prediction-value" id="pred-7d">--</div>
                                    <div class="stat-label">7-Day Prediction</div>
                                    <div class="stat-label" id="pred-7d-confidence">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="prediction-card">
                                    <div class="prediction-value" id="pred-30d">--</div>
                                    <div class="stat-label">30-Day Prediction</div>
                                    <div class="stat-label" id="pred-30d-confidence">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="prediction-card">
                                    <div class="prediction-value" id="pred-90d">--</div>
                                    <div class="stat-label">90-Day Prediction</div>
                                    <div class="stat-label" id="pred-90d-confidence">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Advanced BRI Analytics Dashboard
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-chart-line me-1"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="predictions-tab" data-bs-toggle="tab" data-bs-target="#predictions" type="button" role="tab">
                                    <i class="fas fa-crystal-ball me-1"></i>Predictions
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technical" type="button" role="tab">
                                    <i class="fas fa-chart-bar me-1"></i>Technical Analysis
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                                    <i class="fas fa-brain me-1"></i>Advanced Analytics
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="global-tab" data-bs-toggle="tab" data-bs-target="#global" type="button" role="tab">
                                    <i class="fas fa-globe me-1"></i>Global Markets
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content mt-4" id="dashboardTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="chart-grid chart-grid-single">
                                    <div>
                                        <h6>BRI Time Series with Moving Averages</h6>
                                        <div class="chart-container chart-container-large" id="bri-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Feature Importance Analysis</h6>
                                        <div class="chart-container chart-container-medium" id="feature-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>BRI Distribution & Statistics</h6>
                                        <div class="chart-container chart-container-medium" id="distribution-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-single">
                                    <div>
                                        <h6>BRI vs VIX Correlation Analysis</h6>
                                        <div class="chart-container chart-container-large" id="correlation-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Predictions Tab -->
                            <div class="tab-pane fade" id="predictions" role="tabpanel">
                                <div class="chart-grid chart-grid-single">
                                    <div>
                                        <h6>BRI Forecasting Models (7, 30, 90 Days)</h6>
                                        <div class="chart-container chart-container-large" id="forecasting-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Model Performance Comparison</h6>
                                        <div class="chart-container chart-container-medium" id="model-performance-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>Confidence Intervals</h6>
                                        <div class="chart-container chart-container-medium" id="confidence-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Technical Analysis Tab -->
                            <div class="tab-pane fade" id="technical" role="tabpanel">
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Candlestick Analysis</h6>
                                        <div class="chart-container chart-container-medium" id="candlestick-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>Box Plot Analysis</h6>
                                        <div class="chart-container chart-container-medium" id="box-plot-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Volatility Clustering</h6>
                                        <div class="chart-container chart-container-medium" id="volatility-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>Risk Heatmap</h6>
                                        <div class="chart-container chart-container-medium" id="risk-heatmap-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Analytics Tab -->
                            <div class="tab-pane fade" id="advanced" role="tabpanel">
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Early Warning System</h6>
                                        <div class="chart-container chart-container-medium" id="early-warning-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>Monte Carlo Simulation</h6>
                                        <div class="chart-container chart-container-medium" id="monte-carlo-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-single">
                                    <div>
                                        <h6>Statistical Validation Results</h6>
                                        <div class="chart-container chart-container-large" id="validation-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Global Markets Tab -->
                            <div class="tab-pane fade" id="global" role="tabpanel">
                                <div class="chart-grid chart-grid-single">
                                    <div>
                                        <h6>Global Markets Overview</h6>
                                        <div class="chart-container chart-container-large" id="global-markets-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="chart-grid chart-grid-2">
                                    <div>
                                        <h6>Cryptocurrency Sentiment</h6>
                                        <div class="chart-container chart-container-medium" id="crypto-sentiment-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6>Market Correlation Matrix</h6>
                                        <div class="chart-container chart-container-medium" id="market-correlation-chart">
                                            <div class="loading-spinner">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Information Section -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Current Market Analysis
                    </div>
                    <div class="info-content" id="market-analysis">
                        Loading current market analysis...
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-card">
                    <div class="info-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Technical Indicators
                    </div>
                    <div class="info-content" id="technical-indicators">
                        Loading technical indicators...
                    </div>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            About the Behavioral Risk Index (BRI)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>What is BRI?</h6>
                                <p>The Behavioral Risk Index is a composite measure that quantifies market behavioral instability by analyzing sentiment volatility, news tone, media herding, and event density. It ranges from 0-100, where higher values indicate increased market stress and behavioral risk.</p>
                                
                                <h6>How is BRI Calculated?</h6>
                                <p>BRI combines five key behavioral indicators:</p>
                                <ul>
                                    <li><strong>Sentiment Volatility (30%)</strong> - Panic/fear proxy from social media</li>
                                    <li><strong>Media Herding (20%)</strong> - Herding intensity in news coverage</li>
                                    <li><strong>News Tone (20%)</strong> - Optimism/pessimism in financial news</li>
                                    <li><strong>Event Density (20%)</strong> - Frequency of major market events</li>
                                    <li><strong>Polarity Skew (10%)</strong> - Cognitive bias measure</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Risk Levels</h6>
                                <div class="mb-3">
                                    <span class="badge bg-success me-2">Low (0-30)</span>
                                    <small>Stable market conditions, low behavioral risk</small>
                                </div>
                                <div class="mb-3">
                                    <span class="badge bg-warning me-2">Moderate (30-60)</span>
                                    <small>Normal market volatility, moderate risk</small>
                                </div>
                                <div class="mb-3">
                                    <span class="badge bg-danger me-2">High (60-100)</span>
                                    <small>Elevated stress, high behavioral risk</small>
                                </div>
                                
                                <h6>Data Sources</h6>
                                <ul>
                                    <li><strong>GDELT</strong> - Global news events and sentiment analysis</li>
                                    <li><strong>Reddit/Twitter</strong> - Social media sentiment and engagement</li>
                                    <li><strong>Yahoo Finance</strong> - Market data and VIX correlation</li>
                                    <li><strong>FinBERT</strong> - Advanced financial sentiment analysis</li>
                                </ul>
                                
                                <p class="text-muted small mt-3">
                                    <i class="fas fa-clock me-1"></i>
                                    Last Updated: <span id="last-updated">Loading...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentTheme = localStorage.getItem('theme') || 'light';
        let chartCache = {};
        let isLoading = false;

        // Initialize theme
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon();

        // Theme toggle function
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
            refreshAllCharts();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Enhanced chart loading with proper spinner management
        async function loadChart(chartId, apiEndpoint, containerId) {
            const container = document.getElementById(containerId);
            const spinner = container.querySelector('.loading-spinner');
            
            if (spinner) {
                spinner.style.display = 'block';
            }

            if (chartCache[chartId]) {
                if (spinner) spinner.style.display = 'none';
                Plotly.newPlot(containerId, chartCache[chartId].data, chartCache[chartId].layout, {responsive: true});
                return;
            }

            try {
                const response = await fetch(apiEndpoint);
                if (!response.ok) throw new Error('Failed to fetch chart data');
                
                const chartData = await response.json();
                if (chartData.error) throw new Error(chartData.error);

                if (chartData.layout) {
                    chartData.layout.plot_bgcolor = currentTheme === 'dark' ? '#1A202C' : '#FFFFFF';
                    chartData.layout.paper_bgcolor = currentTheme === 'dark' ? '#1A202C' : '#FFFFFF';
                    chartData.layout.font = { color: currentTheme === 'dark' ? '#F7FAFC' : '#1A202C' };
                }

                chartCache[chartId] = chartData;

                if (spinner) spinner.style.display = 'none';

                Plotly.newPlot(containerId, chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                });

            } catch (error) {
                console.error(`Error loading ${chartId}:`, error);
                if (spinner) spinner.style.display = 'none';
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Failed to load chart</p>
                    </div>
                `;
            }
        }

        // Enhanced summary stats loading
        async function loadSummaryStats() {
            try {
                const response = await fetch('/api/summary');
                const stats = await response.json();
                
                if (stats.error) throw new Error(stats.error);

                // Update main stats
                document.getElementById('current-bri').textContent = stats.current_bri ? stats.current_bri.toFixed(1) : '--';
                document.getElementById('mean-bri').textContent = stats.mean_bri ? stats.mean_bri.toFixed(1) : '--';
                document.getElementById('correlation').textContent = stats.correlation ? stats.correlation.toFixed(3) : '--';
                document.getElementById('trend').textContent = stats.trend || '--';
                document.getElementById('min-bri').textContent = stats.min_bri ? stats.min_bri.toFixed(1) : '--';
                document.getElementById('max-bri').textContent = stats.max_bri ? stats.max_bri.toFixed(1) : '--';
                document.getElementById('last-updated').textContent = stats.last_updated || 'Loading...';

                // Update risk level color
                const currentBriElement = document.getElementById('current-bri');
                const riskLevel = stats.risk_level;
                currentBriElement.className = `stat-value risk-${riskLevel.toLowerCase()}`;

                // Calculate additional metrics
                const briChange = stats.current_bri - stats.mean_bri;
                document.getElementById('bri-change').textContent = `${briChange > 0 ? '+' : ''}${briChange.toFixed(1)} vs mean`;
                
                document.getElementById('bri-volatility').textContent = `Vol: ${stats.std_bri ? stats.std_bri.toFixed(1) : '--'}`;
                
                const corrStrength = Math.abs(stats.correlation);
                let corrText = 'Weak';
                if (corrStrength > 0.7) corrText = 'Strong';
                else if (corrStrength > 0.5) corrText = 'Moderate';
                document.getElementById('correlation-strength').textContent = corrText;
                
                document.getElementById('trend-strength').textContent = stats.trend || '--';

            } catch (error) {
                console.error('Error loading summary stats:', error);
            }
        }

        // Load EMA values
        async function loadEMAValues() {
            try {
                // Generate sample EMA values (in real implementation, these would come from API)
                const emaValues = {
                    'ema-7': 42.3,
                    'ema-14': 41.8,
                    'ema-21': 40.9,
                    'ema-30': 39.7,
                    'ema-50': 38.2,
                    'ema-100': 36.8
                };

                Object.entries(emaValues).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value.toFixed(1);
                    }
                });
            } catch (error) {
                console.error('Error loading EMA values:', error);
            }
        }

        // Load predictions
        async function loadPredictions() {
            try {
                // Generate sample predictions (in real implementation, these would come from API)
                const predictions = {
                    'pred-1d': 43.2,
                    'pred-7d': 45.1,
                    'pred-30d': 47.8,
                    'pred-90d': 52.3
                };

                const confidences = {
                    'pred-1d-confidence': '85% confidence',
                    'pred-7d-confidence': '78% confidence',
                    'pred-30d-confidence': '65% confidence',
                    'pred-90d-confidence': '52% confidence'
                };

                Object.entries(predictions).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value.toFixed(1);
                    }
                });

                Object.entries(confidences).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            } catch (error) {
                console.error('Error loading predictions:', error);
            }
        }

        // Load charts for active tab
        async function loadActiveTabCharts() {
            const activeTab = document.querySelector('.nav-link.active');
            if (!activeTab) return;

            const tabId = activeTab.getAttribute('data-bs-target').substring(1);
            
            switch (tabId) {
                case 'overview':
                    await Promise.all([
                        loadChart('bri-chart', '/api/bri_chart', 'bri-chart'),
                        loadChart('feature-chart', '/api/box_plots', 'feature-chart'),
                        loadChart('distribution-chart', '/api/violin_plots', 'distribution-chart'),
                        loadChart('correlation-chart', '/api/correlation_heatmap', 'correlation-chart')
                    ]);
                    break;
                case 'predictions':
                    await Promise.all([
                        loadChart('forecasting-chart', '/api/forecasting_comparison', 'forecasting-chart'),
                        loadChart('model-performance-chart', '/api/model_performance', 'model-performance-chart'),
                        loadChart('confidence-chart', '/api/confidence_intervals', 'confidence-chart')
                    ]);
                    break;
                case 'technical':
                    await Promise.all([
                        loadChart('candlestick-chart', '/api/candlestick_chart', 'candlestick-chart'),
                        loadChart('box-plot-chart', '/api/box_plots', 'box-plot-chart'),
                        loadChart('volatility-chart', '/api/volatility_clustering', 'volatility-chart'),
                        loadChart('risk-heatmap-chart', '/api/risk_heatmap', 'risk-heatmap-chart')
                    ]);
                    break;
                case 'advanced':
                    await Promise.all([
                        loadChart('early-warning-chart', '/api/early_warning', 'early-warning-chart'),
                        loadChart('monte-carlo-chart', '/api/monte_carlo_visualization', 'monte-carlo-chart'),
                        loadChart('validation-chart', '/api/statistical_validation_report', 'validation-chart')
                    ]);
                    break;
                case 'global':
                    await Promise.all([
                        loadChart('global-markets-chart', '/api/global_markets_overview', 'global-markets-chart'),
                        loadChart('crypto-sentiment-chart', '/api/crypto_sentiment_dashboard', 'crypto-sentiment-chart'),
                        loadChart('market-correlation-chart', '/api/global_markets_correlation', 'market-correlation-chart')
                    ]);
                    break;
            }
        }

        // Refresh all charts
        function refreshAllCharts() {
            chartCache = {};
            loadActiveTabCharts();
        }

        // Tab change handler
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', loadActiveTabCharts);
        });

        // Initialize dashboard
        async function initializeDashboard() {
            await loadSummaryStats();
            await loadEMAValues();
            await loadPredictions();
            await loadActiveTabCharts();
            
            // Auto-refresh every 5 minutes
            setInterval(loadSummaryStats, 300000);
        }

        // Start the dashboard
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
